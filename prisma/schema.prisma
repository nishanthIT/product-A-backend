generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Admin {
  id               Int           @id @default(autoincrement())
  email            String
  password         String
  userType         UserType      @default(ADMIN)
  name             String?
  resetToken       String?
  resetTokenExpiry DateTime?
  reviewedReports  PriceReport[]
}

model Customer {
  id                 Int             @id @default(autoincrement())
  name               String
  mobile             String          @unique
  email              String          @unique
  password           String
  userType           UserType        @default(CUSTOMER)
  earnings           Decimal         @default(0)
  subscriptionStatus String          @default("free_trial")
  trialEndDate       DateTime?
  trialStartDate     DateTime?       @default(now())
  points             Decimal         @default(0)
  resetToken         String?
  resetTokenExpiry   DateTime?
  lists              List[]
  priceReports       PriceReport[]
  productsManaged    ProductAtShop[]
}

model Product {
  id           String          @id @default(cuid())
  title        String
  productUrl   String?
  caseSize     String?
  packetSize   String?
  barcode      String?         @unique
  img          Json?
  retailSize   String?
  caseBarcode  String?
  rrp          Decimal?
  category     String?
  actionLog    ActionLog[]
  priceReports PriceReport[]
  shops        ProductAtShop[]
  promotions   Promotion[]     @relation("ProductToPromotion")
}

model Shop {
  id           String          @id @default(cuid())
  name         String
  address      String
  mobile       String
  actionLog    ActionLog[]
  priceReports PriceReport[]
  products     ProductAtShop[]
  promotions   Promotion[]
}

model ProductAtShop {
  id               String        @id @default(cuid())
  price            Decimal
  shopId           String
  productId        String
  employeeId       Int?
  updatedAt        DateTime?     @default(now())
  userId           Int?
  createdAt        DateTime?     @default(now())
  listId           String?
  card_aiel_number String?
  offerExpiryDate  DateTime?
  offerPrice       Decimal?
  lists            ListProduct[]
  employee         Empolyee?     @relation(fields: [employeeId], references: [id])
  product          Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  shop             Shop          @relation(fields: [shopId], references: [id], onDelete: Cascade)
  customer         Customer?     @relation(fields: [userId], references: [id])

  @@unique([shopId, productId])
  @@index([employeeId, updatedAt])
}

model Empolyee {
  id               Int             @id @default(autoincrement())
  name             String
  phoneNo          String          @unique
  email            String          @unique
  password         String
  userType         UserType        @default(EMPLOYEE)
  resetToken       String?
  resetTokenExpiry DateTime?
  actionLog        ActionLog[]
  productAdded     ProductAtShop[]
}

model ActionLog {
  id         String   @id @default(cuid())
  employeeId Int
  shopId     String
  productId  String
  actionType String
  timestamp  DateTime @default(now())
  employee   Empolyee @relation(fields: [employeeId], references: [id])
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  shop       Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([employeeId, timestamp])
  @@index([shopId, timestamp])
  @@index([productId, timestamp])
}

model List {
  id          String        @id @default(cuid())
  name        String
  description String
  customerId  Int
  customer    Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  products    ListProduct[]
}

model ListProduct {
  id              String        @id @default(cuid())
  listId          String
  productAtShopId String
  quantity        Int           @default(1)
  isPurchased     Boolean       @default(false)
  list            List          @relation(fields: [listId], references: [id], onDelete: Cascade)
  productAtShop   ProductAtShop @relation(fields: [productAtShopId], references: [id], onDelete: Cascade)
}

model Chat {
  id            String            @id @default(cuid())
  name          String?
  type          ChatType          @default(PERSONAL)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  lastMessageAt DateTime?
  participants  ChatParticipant[]
  messages      Message[]
}

model ChatParticipant {
  id       String   @id @default(cuid())
  chatId   String
  userId   Int
  userType UserType
  joinedAt DateTime @default(now())
  isAdmin  Boolean  @default(false)
  chat     Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@unique([chatId, userId, userType])
  @@index([userId, userType])
}

model Message {
  id             String        @id @default(cuid())
  content        String
  chatId         String
  senderId       Int
  senderType     UserType
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  attachmentName String?
  attachmentSize Int?
  attachmentUrl  String?
  deletedAt      DateTime?
  messageType    MessageType   @default(TEXT)
  chat           Chat          @relation(fields: [chatId], references: [id], onDelete: Cascade)
  readReceipts   MessageRead[]

  @@index([chatId, createdAt])
  @@index([senderId, senderType])
}

model MessageRead {
  id        String   @id @default(cuid())
  messageId String
  userId    Int
  userType  UserType
  readAt    DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, userType])
  @@index([userId, userType])
}

model PriceReport {
  id            String       @id @default(cuid())
  reporterId    Int
  productId     String
  shopId        String
  currentPrice  Decimal
  reportedPrice Decimal
  status        ReportStatus @default(PENDING)
  adminNotes    String?
  pointsAwarded Boolean      @default(false)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  reviewedAt    DateTime?
  reviewedBy    Int?
  product       Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  reporter      Customer     @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  reviewer      Admin?       @relation(fields: [reviewedBy], references: [id])
  shop          Shop         @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([reporterId, status])
  @@index([status, createdAt])
  @@index([productId, shopId])
}

model Promotion {
  id          String    @id @default(cuid())
  title       String
  description String?
  imageUrl    String
  shopId      String
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  imageUrls   String[]  @default([])
  pdfUrl      String?
  shop        Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  products    Product[] @relation("ProductToPromotion")

  @@index([shopId, isActive])
  @@index([isActive, createdAt])
}

model Advertisement {
  id        String   @id @default(cuid())
  title     String
  imageUrl  String
  linkUrl   String?
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, sortOrder])
}

model News {
  id          String   @id @default(cuid())
  title       String
  description String
  imageUrl    String?
  sourceUrl   String
  isActive    Boolean  @default(true)
  publishedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive, publishedAt])
}

enum UserType {
  ADMIN
  CUSTOMER
  EMPLOYEE
}

enum ChatType {
  PERSONAL
  GROUP
}

enum MessageType {
  TEXT
  IMAGE
  DOCUMENT
}

enum ReportStatus {
  PENDING
  APPROVED
  REJECTED
}

model Category {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
